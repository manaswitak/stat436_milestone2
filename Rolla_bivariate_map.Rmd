```{r}
#Imports
library(tidyverse)
library(dplyr)
library(DT)
library(sf)
library(ggplot2)
library(tsibble)
library(factoextra)
library(shinyr)
library(shiny)
library(shinydashboard)
library(leaflet)
library(rnaturalearth)
library(rnaturalearthdata)
library(RColorBrewer)
library(htmlwidgets)
library(biscale)
library(palettes)
library(base64enc)
library("ggiraph")

```

```{r}

```



```{r}
#reading tidy WHR

whr=read.csv("whr.csv")


## Unifying country names 
world = ne_countries(scale = "medium", returnclass = "sf") %>%
  st_transform(crs = "+proj=eqearth")

whr_clean = whr %>%
  mutate(Country = recode(Country,
    "United States" = "United States of America",
    "Russia" = "Russian Federation",
    "Czech Republic" = "Czechia",
    "Congo (Brazzaville)" = "Republic of the Congo",
    "Congo (Kinshasa)" = "Democratic Republic of the Congo"
  ))

world_data = world %>%
  left_join(whr_clean, by = c("name" = "Country")) %>%
  mutate(
    # make both axes "higher = better" ONCE, for all rows
    rank_best = -Rank,          # better rank = larger
    trust_val = -Corruption     # lower corruption = larger trust
  )

# palette + CSS defined once

# on theme with WHR logo B) *+`


named_colour_vector <- pal_colour(c(
  "1-1" = "#eee4f5", "2-1" = "#b7c9e2", "3-1" = "#3b73b5",
  "1-2" = "#f0bfd8", "2-2" = "#b5a9e9", "3-2" = "#5662a5",
  "1-3" = "#f49bc5", "2-3" = "#c27bb0", "3-3" = "#7a40a3"
))

#shiny app shenanigans
html_setup_format="
      #map { 
        height: 400px !important; 
        width: 80% !important; 
        margin-left: auto !important;
        margin-right: auto !important;
        display: block;
      }

      .hlegend-box {
        padding: 6px; 
        background: white; 
        border: 1px solid #ccc; 
        border-radius: 6px; 
        width: 320px;
      }
      .hlegend-bar { 
        height: 12px; 
        display: flex; 
        margin-top: 4px; 
      }
      .hlegend-labels {
        display: flex; 
        font-size: 10px; 
        margin-top: 2px;
      }
      .hlegend-labels div { flex: 1; text-align: center; }

      .input-row { margin-top: 20px; }
      .control-panel { padding: 20px; background: #f8f8f8; border-radius: 8px; }
    "



```









```{r}
##Shiny time
# ggplot2 instead of Leaflet, because leaflet had a lot of trouble
# with change of projection setting
ui = fluidPage(
  tags$head(
    tags$style(HTML("
      .control-panel { padding: 20px; background: #f8f8f8; border-radius: 8px; }
      .input-row { margin-top: 20px; }
    "))
  ),


  fluidRow(
    column(
      width = 12,
      ggiraph::girafeOutput("map", height = "600px")
    )
  ),

  fluidRow(
    class = "input-row",
    column(
      width = 12,
      div(
        class = "control-panel",
        fluidRow(
          column(
            width = 4,
            sliderInput("year", "Year:",
              min = min(whr_clean$Year, na.rm = TRUE),
              max = max(whr_clean$Year, na.rm = TRUE),
              value = max(whr_clean$Year, na.rm = TRUE),
              step = 1,
              sep = "",
              width = "100%"
            )
          ),
          column(
            width = 4,
            sliderInput("rank", "Rank:",
              min = min(whr_clean$Rank, na.rm = TRUE),
              max = max(whr_clean$Rank, na.rm = TRUE),
              value = range(whr_clean$Rank, na.rm = TRUE),
              width = "100%"
            )
          ),
          column(
            width = 4,
            sliderInput("trust", "Trust:",
              min = min(whr_clean$Corruption, na.rm = TRUE),
              max = max(whr_clean$Corruption, na.rm = TRUE),
              value = range(whr_clean$Corruption, na.rm = TRUE),
              width = "100%"
            )
          )
        )
      )
    )
  )
)
###########################################################
server = function(input, output, session) {
  filtered_data = reactive({
    world_data %>%
      filter(
        Year == input$year,
        Rank >= input$rank[1],
        Rank <= input$rank[2],
        Corruption >= input$trust[1],
        Corruption <= input$trust[2]
      )
  })
  
  output$map = ggiraph::renderGirafe({
    d = filtered_data()
    
    # Get all countries (not filtered by year - show all countries always)
    all_countries_year <- world
    
    if (nrow(all_countries_year) == 0) {
      return(ggplot() + 
        theme_void() + 
        labs(title = "No data for selected year"))
    }
    # Apply bivariate classification only to filtered data
    if (nrow(d) > 0) {
      d = bi_class(d, x = rank_best, y = trust_val, style = "quantile", dim = 3)
      # Add tooltip text
      d$tooltip_text <- paste0(
        d$name, "\n",
        "Rank: ", d$Rank, "\n",
        "Happiness: ", round(d$Happiness.score, 2), "\n",
        "Trust: ", round(d$Corruption, 3)
      )
    }
    
    # Create the map with layers
    p <- ggplot() +
      # First layer: all countries as silhouettes
      ggiraph::geom_sf_interactive(data = all_countries_year, 
              fill = "#e0e0e0", 
              color = "white", 
              size = 0.2,
              tooltip = NULL) +
      # Second layer: filtered/selected countries with bivariate colors
      {if(nrow(d) > 0) {
        ggiraph::geom_sf_interactive(data = d,
                aes(fill = bi_class, tooltip = tooltip_text), 
                color = "white", 
                size = 0.2)
      }} +
      bi_scale_fill(pal = named_colour_vector, dim = 3, na.value = "#ebebeb") +
      bi_theme() +
      theme(
        plot.background = element_rect(fill = "white", color = NA),
        panel.background = element_rect(fill = "#f1f0f2", color = NA),
        panel.grid.major = element_line(color = "#401161", linewidth = 0.3),
        legend.position = "none"
      ) +
      labs(title = paste("World Happiness & Trust -", input$year))
    
    # Add legend
    legend <- bi_legend(
      pal = named_colour_vector,
      dim = 3,
      xlab = "Better rank",
      ylab = "Higher trust",
      size = 10
    )
    
    # Combine map and legend
    library(cowplot)
    final_plot <- ggdraw() +
      draw_plot(p, 0, 0, 1, 1) +
      draw_plot(legend, 0.05, 0.05, 0.2, 0.2)
    
    # Return girafe object with larger dimensions
    ggiraph::girafe(ggobj = final_plot, width_svg = 12, height_svg = 7)
  })
}
shinyApp(ui, server)
```

```{r}
##lm = lm( Happiness.score~GDP+Generosity+Freedom+Health+Corruption, whr)



