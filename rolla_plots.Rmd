```{r}
library(tidyverse)
library(dplyr)
library(DT)
library(ggplot2)
library(tsibble)
library(factoextra)

```


```{r}

whr=read.csv("whr.csv")

```



```{r}
# library(tidyverse)
# library(factoextra)
# 
# # Select + clean
# df_pca = whr %>%
#   select(
#     Happiness.score,
#     GDP,
#     Health,
#     Corruption
#   ) %>%
#   mutate(across(everything(), as.numeric)) %>%
#   drop_na()
# 
# # Run PCA
# pca = prcomp(df_pca, scale. = TRUE)
# 
# # Results
# print(summary(pca))
# print(pca$rotation)
# 
# # Scree plot
# plot(pca, type = "l", main = "Scree Plot")
# 
# # Biplot
# fviz_pca_biplot(
#   pca,
#   repel = TRUE,
#   col.var = "tomato",
#   col.ind = "navy"
# )


```


```{r}

#aaah shit here we go again
model = lm(Happiness.score ~ GDP + Health + Corruption, data = whr)

summary(model)
```



```{r}

all_scores = whr$Happiness.score
mean_score = mean(all_scores, na.rm = TRUE)
sd_score   = sd(all_scores, na.rm = TRUE)

# ranges
gdp_min    = round(min(whr$GDP, na.rm = TRUE), 3)
gdp_max    = round(max(whr$GDP, na.rm = TRUE), 3)
health_min = round(min(whr$Health, na.rm = TRUE), 3)
health_max = round(max(whr$Health, na.rm = TRUE), 3)
corr_min   = round(min(whr$Corruption, na.rm = TRUE), 3)
corr_max   = round(max(whr$Corruption, na.rm = TRUE), 3)
```


```{r}
#SHINY FAIRY 



ui = fluidPage(
  
  titlePanel("Happiness Score Predictor & Similar Countries"),
  
  sidebarLayout(
    sidebarPanel(
      
      numericInput("gdp", "GDP", value = mean(whr$GDP, na.rm = TRUE)),
      helpText(paste0("Range in data: ", gdp_min, " to ", gdp_max)),
      
      numericInput("health", "Health", value = mean(whr$Health, na.rm = TRUE)),
      helpText(paste0("Range in data: ", health_min, " to ", health_max)),

      numericInput("corr", "Corruption", value = mean(whr$Corruption, na.rm = TRUE)),
      helpText(paste0("Range in data: ", corr_min, " to ", corr_max)),
      
      hr(),
      strong("Predicted Happiness Score:"),
      textOutput("pred")
    ),
    
    mainPanel(
      plotOutput("distPlot", height = "350px"),
      hr(),
      h3("Countries Most Similar to Your Input"),
      DTOutput("similarTable")
    )
  )
)







server = function(input, output, session) {
  
  predicted = reactive({
    newdata = data.frame(
      GDP = input$gdp,
      Health = input$health,
      Corruption = input$corr
    )
    predict(model, newdata)
  })
  
  output$pred = renderText({
    round(predicted(), 3)
  })
  
  output$distPlot = renderPlot({
    dens = density(all_scores, na.rm = TRUE)
    
    plot(dens,
         main = "Predicted Happiness vs Distribution",
         xlab = "Happiness Score", lwd = 3)
    
    abline(v = predicted(), col = "red", lwd = 3)
    text(predicted(), max(dens$y)*0.9,
         paste0("Predicted: ", round(predicted(), 2)),
         pos = 4, col = "red")
    
    abline(v = mean_score, col = "blue", lwd = 2, lty = 2)
  })
  
###
  
  output$similarTable = renderDT({
    
    whr %>%
      mutate(
        dist = sqrt(
          (GDP - input$gdp)^2 +
          (Health - input$health)^2 +
          (Corruption - input$corr)^2
        )
      ) %>%
      arrange(dist) %>%
      slice(1:10) %>%
      select(
        Country,
        Rank,                 
        Happiness.score,
        GDP,
        Health,
        Corruption,
        dist
      ) %>%
      datatable(
        options = list(pageLength = 10),
        rownames = FALSE
      )
  })
}

shinyApp(ui, server)


```


